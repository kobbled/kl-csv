PROGRAM tst_csv_writ
%NOLOCKGROUP

VAR
  block_write FROM tst_csv_main : INTEGER
  pipe_file FROM tst_csv_main : STRING[16]
  entries FROM tst_csv_main : INTEGER
  waitime FROM tst_csv_main : INTEGER
  writedelay FROM tst_csv_main  : INTEGER
  write_fl : FILE
  pose : XYZWPR
  i, tme : INTEGER
  time_out : BOOLEAN

%include csv.klh
%include math.klh

BEGIN

  FOR i=1 TO entries DO
    --wait for writing to display to finish
    --before continuing to write
    PEND_SEMA(block_write, waitime, time_out)
    IF time_out THEN
      GOTO ENDWRIT
    ENDIF
    --create random initial position
    tme = GET_USEC_TIM
    pose = math__rand_position(tme)
    csv__write_row_xyzwpr(pipe_file, write_fl, pose)
    
    POST_SEMA (block_write)

    -- create fake work
    DELAY writedelay
  ENDFOR
  -- write to display for remainder data
  csv__write_display(pipe_file, write_fl)
  csv__clear(pipe_file, write_fl)

  ENDWRIT::
  WRITE TPDISPLAY(CR,'csv write is done.')
  
END tst_csv_writ
